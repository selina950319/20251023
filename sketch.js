// =================================================================

// æ­¥é©Ÿä¸€ï¼šæ¨¡æ“¬æˆç¸¾æ•¸æ“šæ¥æ”¶

// -----------------------------------------------------------------





// let scoreText = "æˆç¸¾åˆ†æ•¸: " + finalScore + "/" + maxScore;

// ç¢ºä¿é€™æ˜¯å…¨åŸŸè®Šæ•¸

let finalScore = 0;

let maxScore = 0;

let scoreText = ""; // ç”¨æ–¼ p5.js ç¹ªåœ–çš„æ–‡å­—





window.addEventListener('message', function (event) {

    // åŸ·è¡Œä¾†æºé©—è­‰...

    // ...

    const data = event.data;

   

    if (data && data.type === 'H5P_SCORE_RESULT') {

       

        // !!! é—œéµæ­¥é©Ÿï¼šæ›´æ–°å…¨åŸŸè®Šæ•¸ !!!

        finalScore = data.score; // æ›´æ–°å…¨åŸŸè®Šæ•¸

        maxScore = data.maxScore;

        scoreText = `æœ€çµ‚æˆç¸¾åˆ†æ•¸: ${finalScore}/${maxScore}`;

       

        console.log("æ–°çš„åˆ†æ•¸å·²æ¥æ”¶:", scoreText);

       

        // ----------------------------------------

        // é—œéµæ­¥é©Ÿ 2: å‘¼å«é‡æ–°ç¹ªè£½ (è¦‹æ–¹æ¡ˆäºŒ)

        // ----------------------------------------

        if (typeof redraw === 'function') {

            redraw();

        }

    }

}, false);





// =================================================================

// æ­¥é©ŸäºŒï¼šä½¿ç”¨ p5.js ç¹ªè£½åˆ†æ•¸ (åœ¨ç¶²é  Canvas ä¸Šé¡¯ç¤º)

// -----------------------------------------------------------------



function setup() {

    // ... (å…¶ä»–è¨­ç½®)

    createCanvas(windowWidth / 2, windowHeight / 2);

    background(255);

    noLoop(); // å¦‚æœæ‚¨å¸Œæœ›åˆ†æ•¸åªæœ‰åœ¨æ”¹è®Šæ™‚æ‰ç¹ªè£½ï¼Œä¿ç•™æ­¤è¡Œ

}



// score_display.js ä¸­çš„ draw() å‡½æ•¸ç‰‡æ®µ



function draw() {
// score_display.js ä¸­çš„ draw() å‡½æ•¸ç‰‡æ®µ

function draw() { 
    background(255); // æ¸…é™¤èƒŒæ™¯

    // è¨ˆç®—ç™¾åˆ†æ¯”
    // ç‚ºäº†é¿å… maxScore ç‚º 0 æ™‚ç”¢ç”ŸéŒ¯èª¤ï¼Œæ–°å¢ä¸€å€‹ç°¡å–®çš„ä¿è­·
    let percentage = (maxScore === 0) ? 0 : (finalScore / maxScore) * 100;

    textSize(80); 
    textAlign(CENTER);
    
    // -----------------------------------------------------------------
    // A. æ ¹æ“šåˆ†æ•¸å€é–“æ”¹è®Šæ–‡æœ¬é¡è‰²å’Œå…§å®¹ (ç•«é¢åæ˜ ä¸€) - **åŠ å…¥ 100% æ»¿åˆ†ç‰¹æ•ˆ**
    // -----------------------------------------------------------------
    
    if (percentage === 100) { // <-- æ–°å¢ï¼šåˆ¤æ–·æ˜¯å¦å‰›å¥½ 100% æ»¿åˆ†
        // æ»¿åˆ†ï¼šå¢åŠ ã€Œç…™ç«ç‰¹æ•ˆã€æ–‡å­—æ¨¡æ“¬
        fill(255, 0, 0); // ä½¿ç”¨ç´…è‰²ä¾†è¡¨ç¤ºå¼·çƒˆçš„æ…¶ç¥æ„Ÿ
        textSize(70); // å­—é«”å¯ä»¥æ”¾å¤§ä»¥å¢åŠ æ…¶ç¥æ„Ÿ
        text("ğŸ‰ å®Œç¾ï¼ç…™ç«æ…¶ç¥ï¼ ğŸ‰", width / 2, height / 2 - 50);
        
    } else if (percentage >= 90) { // è™•ç† 90% åˆ° 99.9% çš„æƒ…æ³
        // é«˜åˆ†ï¼šé¡¯ç¤ºé¼“å‹µæ–‡æœ¬ï¼Œä½¿ç”¨åŸä¾†çš„ç¶ è‰²
        fill(0, 200, 50); // ç¶ è‰² [6]
        textSize(80);
        text("æ­å–œï¼å„ªç•°æˆç¸¾ï¼", width / 2, height / 2 - 50);
        
    } else if (percentage >= 60) {
        // ä¸­ç­‰åˆ†æ•¸ï¼šé¡¯ç¤ºä¸€èˆ¬æ–‡æœ¬ï¼Œä½¿ç”¨é»ƒè‰² [6]
        fill(255, 181, 35);
        textSize(80);
        text("æˆç¸¾è‰¯å¥½ï¼Œè«‹å†æ¥å†å²ã€‚", width / 2, height / 2 - 50);
        
    } else if (percentage > 0) {
        // ä½åˆ†ï¼šé¡¯ç¤ºè­¦ç¤ºæ–‡æœ¬ï¼Œä½¿ç”¨ç´…è‰² [6]
        fill(200, 0, 0);
        textSize(80);
        text("éœ€è¦åŠ å¼·åŠªåŠ›ï¼", width / 2, height / 2 - 50);
        
    } else {
        // å°šæœªæ”¶åˆ°åˆ†æ•¸æˆ–åˆ†æ•¸ç‚º 0
        fill(150);
        textSize(80); // æ¢å¾©é è¨­å¤§å°
        text(scoreText || "ç­‰å¾…æˆç¸¾...", width / 2, height / 2);
    }

    // é¡¯ç¤ºå…·é«”åˆ†æ•¸ (é€™éƒ¨åˆ†ä¸å— A å€å¡Š textSize å½±éŸ¿)
    textSize(50);
    fill(50);
    text(`å¾—åˆ†: ${finalScore}/${maxScore}`, width / 2, height / 2 + 50);
    
    
    // -----------------------------------------------------------------
    // B. æ ¹æ“šåˆ†æ•¸è§¸ç™¼ä¸åŒçš„å¹¾ä½•åœ–å½¢åæ˜  (ç•«é¢åæ˜ äºŒ) - **åŠ å…¥ 100% ç…™ç«åœ–å½¢**
    // -----------------------------------------------------------------
    
    if (percentage === 100) { // <-- æ–°å¢ï¼šæ»¿åˆ†æ™‚ç¹ªè£½ç…™ç«åœ–æ¡ˆ
        // ç…™ç«æ¨¡æ“¬ï¼šç•«å¤šå€‹ä¸åŒé¡è‰²å’Œå¤§å°çš„åœ“é»/æ˜Ÿæ˜Ÿ
        noStroke();
        let baseY = height / 2 + 150;
        
        fill(255, 165, 0, 200); // æ©˜è‰²
        circle(width / 2 - 50, baseY, 50);
        fill(255, 255, 0, 200); // é»ƒè‰²
        circle(width / 2 + 50, baseY, 40);
        fill(255, 0, 255, 200); // ç´«è‰²
        circle(width / 2, baseY + 40, 60);
        
    } else if (percentage >= 90) {
        // åŸ 90% æ•ˆæœï¼šç•«ä¸€å€‹å¤§åœ“åœˆä»£è¡¨å®Œç¾ [7]
        fill(0, 200, 50, 150); // å¸¶é€æ˜åº¦
        noStroke();
        circle(width / 2, height / 2 + 150, 150);
        
    } else if (percentage >= 60) {
        // ç•«ä¸€å€‹æ–¹å½¢ [4]
        fill(255, 181, 35, 150);
        rectMode(CENTER);
        rect(width / 2, height / 2 + 150, 150, 150);
    }
    
    // å¦‚æœæ‚¨æƒ³è¦æ›´è¤‡é›œçš„è¦–è¦ºæ•ˆæœï¼Œé‚„å¯ä»¥æ ¹æ“šåˆ†æ•¸ä¿®æ”¹ç·šæ¢ç²—ç´° (strokeWeight) 
    // æˆ–ä½¿ç”¨ sin/cos å‡½æ•¸è®“åœ–æ¡ˆçš„å‹•ç•«æ•ˆæœæœ‰æ‰€ä¸åŒ [8, 9]ã€‚
}
}
