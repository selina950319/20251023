
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>H5P æˆç¸¾åˆ†æ•¸é¡¯ç¤ºç¯„ä¾‹ (p5.js)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆç¸¾é¡¯ç¤ºèˆ‡ç…™ç«ç‰¹æ•ˆç¯„ä¾‹</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <!-- å¼•å…¥ p5.js å‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/p5.js"></script> 


    <script src="libraries/p5.min.js"></script>
    <script src="libraries/p5.sound.min.js"></script>
    <!-- å¼•å…¥æ‚¨çš„åˆ†æ•¸é¡¯ç¤ºé‚è¼¯ (å¿…é ˆåœ¨ p5.js ä¹‹å¾Œè¼‰å…¥) -->
    <!-- ç¢ºä¿ JS æª”æ¡ˆè¼‰å…¥é †åºæ­£ç¢ºï¼Œä»¥è®“è®Šæ•¸ä½œç”¨æ–¼å…¨åŸŸç¯„åœ [4] -->
    <script src="sketch.js"></script>
    
    <style>
        /* è®“å…§å®¹ç½®ä¸­æ–¹ä¾¿æŸ¥çœ‹ */
        body { 
           display: flex;
            flex-direction: column;
            align-items: center;
            font-family: sans-serif;
            background-color: #f0f0f0;
        }
     #p5CanvasContainer {
            border: 1px solid #ccc;
            margin-top: 20px;
            /* ç¢ºä¿ canvas æœ‰ä¸€å€‹å¯è¦‹çš„å€åŸŸ */
        }
        .controls {
            margin-top: 20px;
            padding: 10px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    </style>
</head>
<body>
    <h1>è‹±æ–‡æ¸¬é©—</h1>
    <h2>æ‹–æ›³ä¸‹æ–¹ç­”æ¡ˆåˆ°ä¸Šæ–¹ç©ºæ ¼</h2>
   <div id="p5CanvasContainer">
        </div>
    
    <div class="controls">
        <p>æ¸¬è©¦æ§åˆ¶é … (æ¨¡æ“¬ H5P æ¶ˆæ¯å‚³é€):</p>
        <button onclick="simulateScore(100, 100)">æ¨¡æ“¬æ»¿åˆ† (100/100) - è§¸ç™¼ç…™ç«</button>
        <button onclick="simulateScore(85, 100)">æ¨¡æ“¬é«˜åˆ† (85/100)</button>
        <button onclick="simulateScore(50, 100)">æ¨¡æ“¬ä½åˆ† (50/100)</button>
        <button onclick="simulateScore(0, 100)">æ¨¡æ“¬é›¶åˆ† (0/100)</button>
    </div>

    <script>
        // =================================================================
        // å…¨åŸŸè®Šæ•¸
        // =================================================================
        let finalScore = 0; 
        let maxScore = 0;
        let scoreText = "è«‹é–‹å§‹æ¸¬é©—æˆ–é»æ“Šæ¨¡æ“¬æŒ‰éˆ•"; // åˆå§‹æ–‡å­—

        // -----------------------------------------------------------------
        // æ­¥é©Ÿä¸€ï¼šæˆç¸¾æ•¸æ“šæ¥æ”¶ (æ¨¡æ“¬ H5P æ¶ˆæ¯æ¥æ”¶)
        // -----------------------------------------------------------------

        // ç›£è½ä¾†è‡ª H5P æˆ–å…¶ä»– iframe çš„ 'message' äº‹ä»¶
        window.addEventListener('message', function (event) {
            // å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œæ‚¨æ‡‰è©²é©—è­‰ event.origin
            // ç¢ºä¿åªè™•ç†ä¾†è‡ªå¯ä¿¡ä»»ä¾†æºçš„æ•¸æ“š
            
            const data = event.data;
            
            if (data && data.type === 'H5P_SCORE_RESULT') {
                
                // !!! é—œéµæ­¥é©Ÿï¼šæ›´æ–°å…¨åŸŸè®Šæ•¸ !!!
                finalScore = data.score; 
                maxScore = data.maxScore;
                scoreText = `æœ€çµ‚æˆç¸¾åˆ†æ•¸: ${finalScore}/${maxScore}`;
                
                console.log("æ–°çš„åˆ†æ•¸å·²æ¥æ”¶:", scoreText); 
                
                // é—œéµæ­¥é©Ÿ 2: å‘¼å«é‡æ–°ç¹ªè£½
                if (typeof redraw === 'function') {
                    redraw(); // p5.js æœƒè‡ªå‹•èª¿ç”¨ draw()ï¼Œä½†æ˜ç¢ºå‘¼å«æ›´å¯é 
                }
            }
        }, false);


        // =================================================================
        // æ­¥é©ŸäºŒï¼šä½¿ç”¨ p5.js ç¹ªè£½åˆ†æ•¸
        // =================================================================

        let p5Instance;

        function setup() { 
            // å‰µå»º canvasï¼Œä¸¦å°‡å…¶æ›è¼‰åˆ°æŒ‡å®šçš„å®¹å™¨ä¸­
            p5Instance = new p5(function(sketch) {
                sketch.setup = function() {
                    // å°‡ canvas å°ºå¯¸è¨­å®šç‚ºé©ä¸­å¤§å°ï¼Œä¸¦æ›è¼‰åˆ° #p5CanvasContainer
                    let container = sketch.select('#p5CanvasContainer');
                    let w = window.innerWidth > 600 ? 600 : window.innerWidth * 0.9;
                    let h = 450;
                    sketch.createCanvas(w, h).parent('p5CanvasContainer'); 
                    sketch.background(255); 
                    sketch.noLoop(); // åªæœ‰åœ¨åˆ†æ•¸æ”¹è®Šæ™‚æ‰ç¹ªåœ–
                };

                sketch.draw = function() { 
                    sketch.background(255); // æ¸…é™¤èƒŒæ™¯

                    // è¨ˆç®—ç™¾åˆ†æ¯”
                    let percentage = (maxScore === 0) ? 0 : (finalScore / maxScore) * 100;

                    sketch.textSize(30); 
                    sketch.textAlign(sketch.CENTER);
                    
                    // -----------------------------------------------------------------
                    // A. æ ¹æ“šåˆ†æ•¸å€é–“æ”¹è®Šæ–‡æœ¬é¡è‰²å’Œå…§å®¹ (ç•«é¢åæ˜ ä¸€)
                    // -----------------------------------------------------------------
                    
                    if (percentage === 100) { // <-- æ»¿åˆ†åˆ¤æ–·ï¼šè§¸ç™¼ç…™ç«æ–‡å­—
                        sketch.textSize(40);
                        sketch.fill(255, 0, 0); // å¼·çƒˆç´…è‰²
                        sketch.text("ğŸ‰ æ­å–œï¼å®Œç¾ç…™ç«ç§€ï¼ ğŸ‰", sketch.width / 2, sketch.height / 2 - 60);
                        
                    } else if (percentage >= 90) {
                        sketch.textSize(30);
                        sketch.fill(0, 200, 50); // ç¶ è‰²
                        sketch.text("æ­å–œï¼å„ªç•°æˆç¸¾ï¼", sketch.width / 2, sketch.height / 2 - 50);
                        
                    } else if (percentage >= 60) {
                        sketch.textSize(30);
                        sketch.fill(255, 181, 35); // é»ƒè‰²
                        sketch.text("æˆç¸¾è‰¯å¥½ï¼Œè«‹å†æ¥å†å²ã€‚", sketch.width / 2, sketch.height / 2 - 50);
                        
                    } else if (percentage > 0) {
                        sketch.textSize(30);
                        sketch.fill(200, 0, 0); // ç´…è‰²
                        sketch.text("éœ€è¦åŠ å¼·åŠªåŠ›ï¼", sketch.width / 2, sketch.height / 2 - 50);
                        
                    } else {
                        sketch.textSize(25);
                        sketch.fill(150);
                        sketch.text(scoreText, sketch.width / 2, sketch.height / 2);
                    }

                    // é¡¯ç¤ºå…·é«”åˆ†æ•¸
                    sketch.textSize(25);
                    sketch.fill(50);
                    sketch.text(`å¾—åˆ†: ${finalScore}/${maxScore}`, sketch.width / 2, sketch.height / 2 + 30);
                    
                    
                    // -----------------------------------------------------------------
                    // B. æ ¹æ“šåˆ†æ•¸è§¸ç™¼ä¸åŒçš„å¹¾ä½•åœ–å½¢åæ˜  (ç•«é¢åæ˜ äºŒ) - ç…™ç«ç‰¹æ•ˆ
                    // -----------------------------------------------------------------
                    
                    if (percentage === 100) { // <-- æ»¿åˆ†åˆ¤æ–·ï¼šè§¸ç™¼ç…™ç«åœ–å½¢
                        sketch.noStroke();
                        // æ¨¡æ“¬ç…™ç«çˆ†ç™¼æ•ˆæœ
                        let baseY = sketch.height / 2 + 120;
                        sketch.fill(255, 165, 0, 200); // æ©˜è‰²
                        sketch.circle(sketch.width / 2 - 50, baseY, 50);
                        sketch.fill(255, 255, 0, 200); // é»ƒè‰²
                        sketch.circle(sketch.width / 2 + 50, baseY, 40);
                        sketch.fill(255, 0, 255, 200); // ç´«è‰²
                        sketch.circle(sketch.width / 2, baseY + 40, 60);
                        
                    } else if (percentage >= 90) {
                        // åŸ 90% æ•ˆæœï¼šå¤§åœ“åœˆ
                        sketch.fill(0, 200, 50, 150); // å¸¶é€æ˜åº¦
                        sketch.noStroke();
                        sketch.circle(sketch.width / 2, sketch.height / 2 + 120, 150);
                        
                    } else if (percentage >= 60) {
                        // ä¸­ç­‰æ•ˆæœï¼šæ–¹å½¢
                        sketch.fill(255, 181, 35, 150);
                        sketch.rectMode(sketch.CENTER);
                        sketch.rect(sketch.width / 2, sketch.height / 2 + 120, 150, 150);
                    }
                };
            }, document.getElementById('p5CanvasContainer')); // å°‡ p5 å¯¦ä¾‹æ›è¼‰åˆ°å®¹å™¨
        }

        // -----------------------------------------------------------------
        // æ¸¬è©¦ç”¨ï¼šæ¨¡æ“¬æˆç¸¾æ•¸æ“šç™¼é€
        // -----------------------------------------------------------------
        function simulateScore(score, max) {
            const mockData = {
                type: 'H5P_SCORE_RESULT',
                score: score,
                maxScore: max
            };
            // å‰µå»ºä¸€å€‹å‡çš„äº‹ä»¶å°è±¡ä¾†è§¸ç™¼ç›£è½å™¨
            const mockEvent = { data: mockData };
            window.dispatchEvent(new MessageEvent('message', { data: mockData }));
            console.log(`--- æ¨¡æ“¬ç™¼é€åˆ†æ•¸: ${score}/${max} ---`);
        }

        // åœ¨ p5 å¯¦ä¾‹åˆå§‹åŒ–å¾Œæ‰åŸ·è¡Œ setup
        window.onload = function() {
            setup();
        };

    </script>
</body>
</html>
